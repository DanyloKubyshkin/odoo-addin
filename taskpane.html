<!DOCTYPE html>
<html>
  <head>
    <!-- Office JavaScript API -->
    <script
      type="text/javascript"
      src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"
    ></script>
    <style>
      #statusMessage {
        font-size: 16px;
        margin-top: 20px;
        color: green;
      }

      #loadingSpinner {
        display: none;
        margin-top: 20px;
      }

      #saveButton:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      /* Styling for the loading spinner */
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body>
    <p>This add-in will send the document to your Odoo system.</p>
    <button id="saveButton">Save Document to Odoo</button>
    <div id="loadingSpinner" class="spinner"></div>
    <div id="statusMessage"></div>

    <script>
      // Ensure Office.js has fully loaded before interacting with Word
      Office.onReady(function (info) {
        if (info.host === Office.HostType.Word) {
          console.log("Office host is Word");

          // Wait for the button to be clicked, then call the save function
          const saveButton = document.getElementById("saveButton");

          if (saveButton) {
            console.log("Button found. Assigning click event.");
            saveButton.onclick = saveDocumentToAPI;
          } else {
            console.error("Save button not found!");
          }
        }
      });

      // Function to save the document to the API
      async function saveDocumentToAPI() {
        const saveButton = document.getElementById("saveButton");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const statusMessage = document.getElementById("statusMessage");

        saveButton.disabled = true;
        loadingSpinner.style.display = "inline-block";
        statusMessage.textContent = "Processing the document... Please wait.";

        try {
          await Word.run(async (context) => {
            const isOnline = window.location.href.includes(
              "officeapps.live.com"
            );

            // Word Online scenario: Export as HTML
            if (isOnline) {
              const documentContent = context.document.body.getHtml();
              await context.sync();
              const htmlContent = documentContent.value;

              const blob = new Blob([htmlContent], { type: "text/html" });
              const formData = new FormData();
              formData.append("file", blob, "document.html");

              await sendFileToAPI(formData, statusMessage);
            } else {
              // Word Desktop scenario: Export as .docx
              if (typeof Word.FileType === "undefined") {
                throw new Error("Word.FileType is not defined.");
              }

              const fileType = Word.FileType.Docx;
              const documentBase64 = await context.document.getFileAsync(
                fileType
              );

              const base64File = documentBase64.value;
              const byteCharacters = atob(base64File);
              const byteArrays = [];

              for (
                let offset = 0;
                offset < byteCharacters.length;
                offset += 1024
              ) {
                const slice = byteCharacters.slice(offset, offset + 1024);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                  byteNumbers[i] = slice.charCodeAt(i);
                }
                byteArrays.push(new Uint8Array(byteNumbers));
              }

              const formData = new FormData();
              const blob = new Blob(byteArrays, {
                type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
              });
              formData.append("file", blob, "document.docx");

              await sendFileToAPI(formData, statusMessage);
            }
          });
        } catch (error) {
          console.error("Error saving document:", error);
          statusMessage.textContent = `Error saving document: ${error.message}`;
          statusMessage.style.color = "red";
        } finally {
          saveButton.disabled = false;
          loadingSpinner.style.display = "none";
        }
      }

      async function sendFileToAPI(formData, statusMessage) {
        const apiURL =
          "https://tabatabai-group-bis-detcom-staging-2023-06-12-10366806.dev.odoo.com/docx_save_button/save";

        try {
          const response = await fetch(apiURL, {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            statusMessage.textContent = "Document saved successfully.";
            statusMessage.style.color = "green";
          } else {
            statusMessage.textContent = `Failed to save document. Status: ${response.status}`;
            statusMessage.style.color = "red";
          }
        } catch (error) {
          console.error("Error sending the file to API:", error);
          statusMessage.textContent = `Error sending document: ${error.message}`;
          statusMessage.style.color = "red";
        }
      }
    </script>
  </body>
</html>
