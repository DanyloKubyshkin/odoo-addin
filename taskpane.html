<!DOCTYPE html>
<html>
  <head>
    <!-- Office JavaScript API -->
    <script
      type="text/javascript"
      src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"
    ></script>
  </head>

  <body>
    <p>This add-in will send the document to your Odoo system.</p>
    <button id="saveButton">Save Document to Odoo</button>

    <script>
      Office.onReady((info) => {
        if (info.host === Office.HostType.Word) {
          document.getElementById("saveButton").onclick = saveDocumentToAPI;
        }
      });

      async function saveDocumentToAPI() {
        try {
          // Run the Word API to get the document content as a .docx file (compressed)
          await Word.run(async (context) => {
            const documentBase64 = await context.document.getFileAsync(
              Word.FileType.Compressed
            );

            // Convert the .docx content to Base64 string
            const base64File = documentBase64.value;

            // Create a FormData object to send the file
            const formData = new FormData();
            const blob = new Blob(
              [
                new Uint8Array(
                  atob(base64File)
                    .split("")
                    .map((c) => c.charCodeAt(0))
                ),
              ],
              {
                type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
              }
            );
            formData.append("file", blob, "document.docx");

            // Prepare the API URL (this should be the correct endpoint for your system)
            const apiURL =
              "https://tabatabai-group-bis-detcom-staging-2023-06-12-10366806.dev.odoo.com/docx_save_button/save";

            // Send the document as a file upload
            const response = await fetch(apiURL, {
              method: "POST",
              body: formData,
            });

            // Handle the response
            if (response.ok) {
              alert("Document saved successfully.");
            } else {
              alert(`Failed to save document. Status: ${response.status}`);
            }
          });
        } catch (error) {
          console.error("Error saving document:", error);
          alert(`Error saving document: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
