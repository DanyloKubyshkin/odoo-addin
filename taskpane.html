<!DOCTYPE html>
<html>
  <head>
    <!-- Office JavaScript API -->
    <script
      type="text/javascript"
      src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"
    ></script>
    <style>
      #statusMessage {
        font-size: 16px;
        margin-top: 20px;
        color: green;
      }

      #loadingSpinner {
        display: none;
        margin-top: 20px;
      }

      #saveButton:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      /* Styling for the loading spinner */
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body>
    <p>This add-in will send the document to your Odoo system.</p>
    <button id="saveButton">Save Document to Odoo</button>
    <div id="loadingSpinner" class="spinner"></div>
    <div id="statusMessage"></div>

    <script>
      // Make sure the Office JavaScript API is ready
      Office.onReady((info) => {
        if (info.host === Office.HostType.Word) {
          document.getElementById("saveButton").onclick = saveDocumentToAPI;
        }
      });

      async function saveDocumentToAPI() {
        // Disable the button and show loading spinner
        const saveButton = document.getElementById("saveButton");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const statusMessage = document.getElementById("statusMessage");

        saveButton.disabled = true;
        loadingSpinner.style.display = "inline-block";
        statusMessage.textContent = "Processing the document... Please wait.";

        try {
          await Word.run(async (context) => {
            // Get the document content as a .docx file (instead of Compressed, use Word.FileType.Docx or Word.FileType.Pdf)
            const documentBase64 = await context.document.getFileAsync(
              Word.FileType.Docx
            ); // Change this line

            const base64File = documentBase64.value;

            // Create a FormData object to send the file
            const formData = new FormData();
            const blob = new Blob(
              [
                new Uint8Array(
                  atob(base64File)
                    .split("")
                    .map((c) => c.charCodeAt(0))
                ),
              ],
              {
                type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
              }
            );
            formData.append("file", blob, "document.docx");

            // Prepare the API URL
            const apiURL =
              "https://tabatabai-group-bis-detcom-staging-2023-06-12-10366806.dev.odoo.com/docx_save_button/save";

            // Send the document as a file upload
            const response = await fetch(apiURL, {
              method: "POST",
              body: formData,
            });

            // Handle the response
            if (response.ok) {
              statusMessage.textContent = "Document saved successfully.";
              statusMessage.style.color = "green";
            } else {
              statusMessage.textContent = `Failed to save document. Status: ${response.status}`;
              statusMessage.style.color = "red";
            }
          });
        } catch (error) {
          console.error("Error saving document:", error);
          statusMessage.textContent = `Error saving document: ${error.message}`;
          statusMessage.style.color = "red";
        } finally {
          // Re-enable the button and hide the loading spinner
          saveButton.disabled = false;
          loadingSpinner.style.display = "none";
        }
      }
    </script>
  </body>
</html>
